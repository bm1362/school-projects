<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <script src="JavaScript/modernizr-1.7.min.js"></script>
    <script type="text/javascript" src="JavaScript/Three.js"></script> <! 3d Engine created by MrDoob >
    <script type="text/javascript" src="JavaScript/Stats.js"></script> <! //Prints FPS output, author unknown, source: github.com/mrdoob>
    <script type="text/javascript" src="JavaScript/ThreeExtras.js"></script>
    <script type="text/javascript" src="JavaScript/RequestAnimationFrame.js"></script> 
  <title>Plot 3D</title>
  <body onload="init();" bgcolor="#000000">
    <console><span id="out"></span></console>
  </body>
</html>

<script type="text/javascript">
{
	if(!Modernizr.canvas | !Modernizr.webgl)
	   document.getElementById("out").innerHTML = "Your browser does not support HTML5/WebGL";
	else {
		
    var canvasWidth = window.innerWidth;
    var canvasHeight = window.innerHeight - 200;
    var windowHalfX = canvasWidth/2;
    var windowHalfY = canvasHeight/2;

    var eq, zT, multX = 5, multY = 5, multZ = .5; //zT = the equation generated by anonymous function call. eq is a string used to check the equation for x's and y's.
    var mouseX = 0, mouseY = 0;
    var lat = 0, lon = 0, phy = 0, theta = 0;	
	var moveForward = false, moveBackward = false, moveLeft = false, moveRight = false;
	
    var camera, scene, renderer;
	
    var upperBoundX, upperBoundY, lowerBoundX, lowerBoundY;
    upperBoundX = upperBoundY = 40;
    lowerBoundX = lowerBoundY = -40;
   
    //setInterval( loop, 1000 / 60 );
    function init() 
    {
        camera = new THREE.Camera( 75, canvasWidth / canvasHeight, 1, 10000 );
	    //camera.focus = 5;
	    camera.position.z = 200;
        
        scene = new THREE.Scene();
	
	    //drawOrigin();

	    zT = new Function('x,y','return '+ prompt('Z(x,y) = ', "x*x*x + y*y*y"));
	    eq = "" + zT;
	   
	    if( eq.lastIndexOf("x") == 19 ) // if there is no x in the equation then this results to 19.
		    multX = 0;
	   
   	    if( eq.lastIndexOf("y") == 21 )
	        multY = 0;
			
	   for (var y = lowerBoundY ; y < upperBoundY; y+=1) 
       {
	     for( var x = lowerBoundX; x < upperBoundX; x+=1)
	     {
	        var particle = new THREE.Particle( new THREE.ParticleCircleMaterial( { color: Math.random() *  0xffffff } ) );		   
	        particle.position.x = x * multX; //multX is a multiplier
	        particle.position.y = y * multY;
		    particle.position.z = zT(x,y) * multZ; //* 20;
			   
            particle.scale.x = particle.scale.y = 5;
            scene.addObject( particle );
	    }
       }

        renderer = new THREE.CanvasRenderer();
        renderer.setSize( canvasWidth, canvasHeight );

        document.body.appendChild( renderer.domElement );
		
		stats = new Stats();
		stats.domElement.style.position = 'absolute';
		stats.domElement.style.top = '0px';
		document.body.appendChild( stats.domElement );
		
	    document.addEventListener('mousemove', onDocumentMouseMove, false);
		document.addEventListener('keydown', onDocumentKeyPressed, false);
		document.addEventListener('keyup', onDocumentKeyUp, false);
     loop();

    }

    function loop() 
    {   

	requestAnimationFrame( loop );
 	    //rotate();
        renderer.render( scene, camera );
		stats.update();
	    //outputToConsole();
		calculateCamera();
    }

    function onDocumentMouseMove(event) 
    {		
       mouseX = event.clientX - windowHalfX;
       mouseY = event.clientY - windowHalfY;
    }
	
	function onDocumentKeyPressed(event)
	{
		//alert("Registering " + event.keyCode );
		if(event.keyCode == 87) //move forward
		   moveForward = true;
		if(event.keyCode == 83) //move backward
		   moveBackward = true;
		if(event.keyCode == 65) //move left
		   moveLeft = true;
		if(event.keyCode == 68) //move right
		   moveRight = true;
	}
	
	function onDocumentKeyUp(event)
	{
		//alert("Registering " + event.keyCode );
		if(event.keyCode == 87) //move forward
		   moveForward = false;
		if(event.keyCode == 83) //move backward
		   moveBackward = false;
		if(event.keyCode == 65) //move left
		   moveLeft = false;
		if(event.keyCode == 68) //move right
		   moveRight = false;
	}

    function rotate()
    {
	   camera.position.x += ( 5*mouseX - camera.position.x);
	   camera.position.y += (-5*mouseY - camera.position.y);
    }

    function calculateCamera()
    {
		//src mrdoob, minor tweaking.
		if ( moveForward )  camera.translateZ( - 15 );
		if ( moveBackward ) camera.translateZ( 15 );
		if ( moveLeft )     camera.translateX( - 15 );
		if ( moveRight )    camera.translateX( 15 );
		
		lon += mouseX * 0.005; //x influence
		lat -= mouseY * 0.005; //y influence
 
		lat = Math.max( - 85, Math.min( 85, lat ) );
		phi = ( 90 - lat ) * Math.PI / 180; //phi = ( 90 degrees - the Y influence )
		theta = lon * Math.PI / 180; //theta = the x influence
 
		camera.target.position.x = 100 * Math.sin( phi ) * Math.cos( theta ) + camera.position.x;
		camera.target.position.y = 100 * Math.cos( phi ) + camera.position.y;
		camera.target.position.z = 100 * Math.sin( phi ) * Math.sin( theta ) + camera.position.z;
    }

    function drawOrigin()
    {
       for( i = 0; i < 1000; i++ )
       {
            var xAxis = new THREE.Particle( new THREE.ParticleCircleMaterial( { color: 	0xDC143C } ) );
            xAxis.position.x = i;
            xAxis.position.y = 0;
            xAxis.position.z = 0;
            xAxis.scale.x = xAxis.scale.y = 5;
            scene.addObject( xAxis );

	    var yAxis = new THREE.Particle( new THREE.ParticleCircleMaterial( { color: 0x27408B } ) );
            yAxis.position.x = 0;
            yAxis.position.y = i;
            yAxis.position.z = 0;
            yAxis.scale.x = yAxis.scale.y = 5;
            scene.addObject( yAxis );

            var zAxis = new THREE.Particle( new THREE.ParticleCircleMaterial( { color: 0x548B54 } ) );
            zAxis.position.x = 0;
            zAxis.position.y = 0;
            zAxis.position.z = i;
            zAxis.scale.x = zAxis.scale.y = 5;
            scene.addObject( zAxis );
       }
    }

   function outputToConsole()
   {
      var outString = "Mouse: (" + mouseX + ", " + mouseY + ") Camera: (" + Math.floor(camera.position.x) + ", " + Math.floor(camera.position.y) +", " + Math.floor(camera.position.z) + ")<br>";
	  outString += "Domain-X: (" + lowerBoundX +", " + upperBoundX + ") Domain-Y: (" + lowerBoundY +", " + upperBoundY + ") ";
      outString += "Rendering: " +  eq.substring(eq.indexOf("return ") + 7);
      document.getElementById("out").innerHTML = outString;
   }
}
}
</script>
